<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Chercy's European Adventure</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(180deg, #E8F4F8 0%, #F0F8E8 100%);
            min-height: 100vh;
            color: #2d3748;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 40px 20px;
        }

        .main-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: #2d3748;
            line-height: 1.2;
            margin-bottom: 0;
        }

        .form-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .form-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2d3748;
            text-align: center;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 500;
            color: #2d3748;
            font-size: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 16px;
            background: white;
            color: #2d3748;
            transition: all 0.3s ease;
        }

        .form-control::placeholder {
            color: #a0aec0;
        }

        .form-control:focus {
            outline: none;
            border-color: #4dd0e1;
            box-shadow: 0 0 0 3px rgba(77, 208, 225, 0.1);
        }

        .submit-btn {
            width: 100%;
            background: #4dd0e1;
            color: white;
            border: none;
            padding: 18px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background: #26c6da;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(77, 208, 225, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .success-message {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid #48bb78;
            color: #2f855a;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .success-message.show {
            display: block;
            animation: fadeInDown 0.5s ease-out;
        }

        .map-container {
            width: 100%;
            max-width: 500px;
            display: none;
            margin-top: 30px;
            animation: fadeInUp 0.8s ease-out;
        }

        .map-container.show {
            display: block;
        }

        .map-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .map-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.8);
            text-align: center;
        }

        .map-header h2 {
            color: #2d3748;
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .map-header p {
            color: #718096;
            font-size: 14px;
            margin: 0;
        }

        #map {
            height: 400px;
            width: 100%;
        }

        .friends-section {
            margin-top: 30px;
            width: 100%;
            max-width: 500px;
            display: none;
        }

        .friends-section.show {
            display: block;
            animation: fadeInUp 0.8s ease-out;
        }

        .friends-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .friends-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .friends-header h2 {
            color: #2d3748;
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .friends-subtitle {
            color: #718096;
            font-size: 14px;
            margin: 0;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            background: #edf2f7;
            transform: translateX(3px);
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4dd0e1 0%, #26c6da 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }

        .friend-details h4 {
            color: #2d3748;
            margin: 0 0 3px 0;
            font-weight: 600;
        }

        .friend-details p {
            color: #718096;
            font-size: 13px;
            margin: 0;
        }

        .thank-you {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            display: none;
            width: 100%;
            max-width: 500px;
        }

        .thank-you.show {
            display: block;
            animation: fadeInUp 0.8s ease-out;
        }

        .thank-you h3 {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.3rem;
        }

        .thank-you p {
            color: #718096;
            font-size: 14px;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-container {
                padding: 30px 25px;
                margin: 0 10px 30px 10px;
            }

            .map-container {
                margin: 30px 0 0 0;
            }

            .thank-you {
                margin: 20px 0 0 0;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>Plan Chercy's<br>European Adventure</h1>
        </div>

        <div class="form-container">
            <h2 class="form-title">Mark Your Location</h2>
            
            <div class="success-message" id="successMessage">
                ‚ú® Location added successfully! Your pin is now on the map.
            </div>

            <form id="locationForm">
                <div class="form-group">
                    <label for="friendName">Your name</label>
                    <input type="text" id="friendName" class="form-control" placeholder="Enter your name" required>
                </div>

                <div class="form-group">
                    <label for="friendLocation">The city you live</label>
                    <input type="text" id="friendLocation" class="form-control" placeholder="e.g. Paris/ Berlin..." required>
                    <small style="color: #718096; font-size: 12px; margin-top: 5px; display: block;">
                        üí° Tip: Major European cities work best, or use "latitude, longitude" format
                    </small>
                </div>

                <div class="form-group">
                    <label for="friendNotes">Notes for Chercy</label>
                    <input type="text" id="friendNotes" class="form-control" placeholder="Best time to visit, local recommendations...">
                    <small style="color: #718096; font-size: 12px; margin-top: 5px; display: block;">
                        üîí These notes are private - only Chercy will see them
                    </small>
                </div>

                <div class="form-group">
                    <label for="otherCities">Other cities you recommend</label>
                    <input type="text" id="otherCities" class="form-control" placeholder="e.g. Prague, Budapest, Barcelona...">
                    <small style="color: #718096; font-size: 12px; margin-top: 5px; display: block;">
                        üí° Suggest other European cities Chercy should visit
                    </small>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    Add your location
                </button>
            </form>
        </div>

        <div class="map-container" id="mapContainer">
            <div class="map-card">
                <div class="map-header">
                    <h2>‚úÖ Your Location Added!</h2>
                    <p>You're now on Chercy's travel map</p>
                </div>
                <div id="map"></div>
            </div>
        </div>

        <div class="friends-section" id="friendsSection">
            <div class="friends-card">
                <div class="friends-header">
                    <h2>üåç Friends Helping Plan the Trip</h2>
                    <p class="friends-subtitle"><span id="friendCount">Loading...</span> friends have joined so far!</p>
                </div>
                <div id="friendsList">
                    <div class="loading">
                        <p>Loading friends...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="thank-you" id="thankYou">
            <h3>üéâ Thanks for helping plan the trip!</h3>
            <p>Chercy will use your location to create the perfect European adventure route. Your notes have been saved privately for her planning.</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let friends = [];
        let markers = [];
        let leafletLoaded = false;

        // Pre-defined coordinates for major European cities
        const cityCoordinates = {
            'london': { lat: 51.5074, lng: -0.1278, name: 'London, UK' },
            'london, uk': { lat: 51.5074, lng: -0.1278, name: 'London, UK' },
            'paris': { lat: 48.8566, lng: 2.3522, name: 'Paris, France' },
            'paris, france': { lat: 48.8566, lng: 2.3522, name: 'Paris, France' },
            'berlin': { lat: 52.5200, lng: 13.4050, name: 'Berlin, Germany' },
            'berlin, germany': { lat: 52.5200, lng: 13.4050, name: 'Berlin, Germany' },
            'rome': { lat: 41.9028, lng: 12.4964, name: 'Rome, Italy' },
            'rome, italy': { lat: 41.9028, lng: 12.4964, name: 'Rome, Italy' },
            'madrid': { lat: 40.4168, lng: -3.7038, name: 'Madrid, Spain' },
            'madrid, spain': { lat: 40.4168, lng: -3.7038, name: 'Madrid, Spain' },
            'amsterdam': { lat: 52.3676, lng: 4.9041, name: 'Amsterdam, Netherlands' },
            'amsterdam, netherlands': { lat: 52.3676, lng: 4.9041, name: 'Amsterdam, Netherlands' },
            'vienna': { lat: 48.2082, lng: 16.3738, name: 'Vienna, Austria' },
            'vienna, austria': { lat: 48.2082, lng: 16.3738, name: 'Vienna, Austria' },
            'prague': { lat: 50.0755, lng: 14.4378, name: 'Prague, Czech Republic' },
            'prague, czech republic': { lat: 50.0755, lng: 14.4378, name: 'Prague, Czech Republic' },
            'budapest': { lat: 47.4979, lng: 19.0402, name: 'Budapest, Hungary' },
            'budapest, hungary': { lat: 47.4979, lng: 19.0402, name: 'Budapest, Hungary' },
            'warsaw': { lat: 52.2297, lng: 21.0122, name: 'Warsaw, Poland' },
            'warsaw, poland': { lat: 52.2297, lng: 21.0122, name: 'Warsaw, Poland' },
            'stockholm': { lat: 59.3293, lng: 18.0686, name: 'Stockholm, Sweden' },
            'stockholm, sweden': { lat: 59.3293, lng: 18.0686, name: 'Stockholm, Sweden' },
            'copenhagen': { lat: 55.6761, lng: 12.5683, name: 'Copenhagen, Denmark' },
            'copenhagen, denmark': { lat: 55.6761, lng: 12.5683, name: 'Copenhagen, Denmark' },
            'oslo': { lat: 59.9139, lng: 10.7522, name: 'Oslo, Norway' },
            'oslo, norway': { lat: 59.9139, lng: 10.7522, name: 'Oslo, Norway' },
            'helsinki': { lat: 60.1699, lng: 24.9384, name: 'Helsinki, Finland' },
            'helsinki, finland': { lat: 60.1699, lng: 24.9384, name: 'Helsinki, Finland' },
            'zurich': { lat: 47.3769, lng: 8.5417, name: 'Zurich, Switzerland' },
            'zurich, switzerland': { lat: 47.3769, lng: 8.5417, name: 'Zurich, Switzerland' },
            'brussels': { lat: 50.8503, lng: 4.3517, name: 'Brussels, Belgium' },
            'brussels, belgium': { lat: 50.8503, lng: 4.3517, name: 'Brussels, Belgium' },
            'lisbon': { lat: 38.7223, lng: -9.1393, name: 'Lisbon, Portugal' },
            'lisbon, portugal': { lat: 38.7223, lng: -9.1393, name: 'Lisbon, Portugal' },
            'athens': { lat: 37.9838, lng: 23.7275, name: 'Athens, Greece' },
            'athens, greece': { lat: 37.9838, lng: 23.7275, name: 'Athens, Greece' },
            'dublin': { lat: 53.3498, lng: -6.2603, name: 'Dublin, Ireland' },
            'dublin, ireland': { lat: 53.3498, lng: -6.2603, name: 'Dublin, Ireland' },
            'edinburgh': { lat: 55.9533, lng: -3.1883, name: 'Edinburgh, Scotland' },
            'edinburgh, scotland': { lat: 55.9533, lng: -3.1883, name: 'Edinburgh, Scotland' },
            'munich': { lat: 48.1351, lng: 11.5820, name: 'Munich, Germany' },
            'munich, germany': { lat: 48.1351, lng: 11.5820, name: 'Munich, Germany' },
            'barcelona': { lat: 41.3851, lng: 2.1734, name: 'Barcelona, Spain' },
            'barcelona, spain': { lat: 41.3851, lng: 2.1734, name: 'Barcelona, Spain' },
            'milan': { lat: 45.4642, lng: 9.1900, name: 'Milan, Italy' },
            'milan, italy': { lat: 45.4642, lng: 9.1900, name: 'Milan, Italy' },
            'florence': { lat: 43.7696, lng: 11.2558, name: 'Florence, Italy' },
            'florence, italy': { lat: 43.7696, lng: 11.2558, name: 'Florence, Italy' },
            'venice': { lat: 45.4408, lng: 12.3155, name: 'Venice, Italy' },
            'venice, italy': { lat: 45.4408, lng: 12.3155, name: 'Venice, Italy' },
            'nice': { lat: 43.7102, lng: 7.2620, name: 'Nice, France' },
            'nice, france': { lat: 43.7102, lng: 7.2620, name: 'Nice, France' },
            'lyon': { lat: 45.7640, lng: 4.8357, name: 'Lyon, France' },
            'lyon, france': { lat: 45.7640, lng: 4.8357, name: 'Lyon, France' },
            'cologne': { lat: 50.9375, lng: 6.9603, name: 'Cologne, Germany' },
            'cologne, germany': { lat: 50.9375, lng: 6.9603, name: 'Cologne, Germany' },
            'frankfurt': { lat: 50.1109, lng: 8.6821, name: 'Frankfurt, Germany' },
            'frankfurt, germany': { lat: 50.1109, lng: 8.6821, name: 'Frankfurt, Germany' },
        };

        // Wait for Leaflet to load
        function waitForLeaflet() {
            return new Promise((resolve) => {
                if (typeof L !== 'undefined') {
                    leafletLoaded = true;
                    resolve();
                } else {
                    setTimeout(() => waitForLeaflet().then(resolve), 100);
                }
            });
        }

        // Initialize map
        async function initMap() {
            try {
                await waitForLeaflet();

                map = L.map('map', {
                    preferCanvas: true,
                    zoomControl: true,
                    attributionControl: true
                }).setView([50.0755, 14.4378], 4);

                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '¬© OpenStreetMap contributors',
                    detectRetina: true,
                    updateWhenIdle: true,
                    keepBuffer: 2
                }).addTo(map);
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        // Add marker to map
        function addMarkerToMap(friend) {
            try {
                if (!leafletLoaded || typeof L === 'undefined' || !map) {
                    return;
                }

                const marker = L.marker([friend.coords.lat, friend.coords.lng]).addTo(map)
                    .bindPopup(`
                        <div style="text-align: center; padding: 15px; min-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; color: #2d3748; font-size: 16px;">${friend.name}</h3>
                            <p style="margin: 0 0 8px 0; color: #718096; font-size: 13px;">üìç ${friend.location}</p>
                        </div>
                    `);

                markers.push(marker);
            } catch (error) {
                console.error('Error adding marker:', error);
            }
        }

        // Load friends from API
        async function loadFriends() {
            try {
                const response = await fetch('/api/friends/public');
                if (!response.ok) {
                    throw new Error('Failed to load friends');
                }

                friends = await response.json();
                
                // Initialize map first
                if (!map) {
                    await initMap();
                }

                // Clear existing markers
                markers.forEach(marker => {
                    if (map && marker) {
                        map.removeLayer(marker);
                    }
                });
                markers = [];

                // Add markers for all friends
                friends.forEach(friend => addMarkerToMap(friend));
                updateFriendsDisplay();

                // Fit map to show all markers
                if (markers.length > 0) {
                    setTimeout(() => {
                        const group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }, 500);
                }
            } catch (error) {
                console.error('Error loading friends:', error);
                // Initialize empty map if API fails
                if (!map) {
                    await initMap();
                }
                updateFriendsDisplay();
            }
        }

        // Update friends display
        function updateFriendsDisplay() {
            const friendsList = document.getElementById('friendsList');
            const friendCount = document.getElementById('friendCount');
            
            if (friendCount) {
                friendCount.textContent = friends.length;
            }

            if (!friendsList) return;

            if (friends.length === 0) {
                friendsList.innerHTML = `
                    <div class="loading">
                        <p>No friends have joined yet! Be the first to add your location.</p>
                    </div>
                `;
                return;
            }

            friendsList.innerHTML = friends.map(friend => `
                <div class="friend-item">
                    <div class="friend-avatar">${friend.name.charAt(0).toUpperCase()}</div>
                    <div class="friend-details">
                        <h4>${friend.name}</h4>
                        <p>üìç ${friend.location}</p>
                    </div>
                </div>
            `).join('');
        }

        // Parse coordinates from string
        function parseCoordinates(location) {
            // Check if it's in "lat, lng" format
            const coordPattern = /^[-+]?([0-8]?\d(\.\d+)?|90(\.0+)?),\s*[-+]?((1[0-7]\d(\.\d+)?)|180(\.0+)?|(\d{1,2}(\.\d+)?))$/;
            if (coordPattern.test(location.trim())) {
                const [latStr, lngStr] = location.trim().split(',');
                return {
                    lat: parseFloat(latStr.trim()),
                    lng: parseFloat(lngStr.trim()),
                    name: location.trim()
                };
            }
            
            // Check predefined cities
            const key = location.toLowerCase().trim();
            return cityCoordinates[key] || null;
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');
            const mapContainer = document.getElementById('mapContainer');
            const friendsSection = document.getElementById('friendsSection');
            const thankYou = document.getElementById('thankYou');
            
            const formData = {
                name: document.getElementById('friendName').value.trim(),
                location: document.getElementById('friendLocation').value.trim(),
                notes: document.getElementById('friendNotes').value.trim(),
                otherCities: document.getElementById('otherCities').value.trim()
            };

            if (!formData.name || !formData.location) {
                alert('Please fill in both your name and location!');
                return;
            }

            // Parse coordinates
            const coords = parseCoordinates(formData.location);
            if (!coords) {
                alert('Sorry, we couldn\'t find that location. Try a major European city or use "latitude, longitude" format.');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding your location...';

            try {
                const response = await fetch('/api/friends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...formData,
                        coords: coords,
                        displayName: coords.name
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to add location');
                }

                // Show success message
                successMessage.classList.add('show');
                
                // Reload friends data
                await loadFriends();
                
                // Show map and friends section
                mapContainer.classList.add('show');
                friendsSection.classList.add('show');
                thankYou.classList.add('show');
                
                // Reset form
                document.getElementById('locationForm').reset();
                
                setTimeout(() => {
                    successMessage.classList.remove('show');
                }, 3000);

            } catch (error) {
                console.error('Error adding friend:', error);
                alert('Sorry, there was an error adding your location. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add your location';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Set up form handler
            const form = document.getElementById('locationForm');
            if (form) {
                form.addEventListener('submit', handleSubmit);
            }
            
            // Load existing friends
            await loadFriends();
        });

        // Auto-refresh data every 30 seconds
        setInterval(async () => {
            await loadFriends();
        }, 30000);

    </script>
</body>
</html>